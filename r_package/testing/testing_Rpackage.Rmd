---
title: "Testing of BEST-COST R package"
author: "Alberto Castro & Axel Luyten"
output: html_document
---
# Goal
Recreate calculation of AirQ+ with {bestcost}. For this, all necessary input data is loaded and manipulated to fit the required formats of {bestcost}. Then, the health impacts are calculated.

Pending
- Create table comparing the AirQ+ and bestcost results to always control that we do not deviate.
- Compare morbidity (not only mortality)
- healthiar vs. geluft in the package
- test

# Load packages

Load the Rdata file that contains all variables needed to run this script.
```{r load data}
load("../testing/input/input data for testing_Rpackage.RData")
```


The R script required the loading of certain R packages. 
```{r Load packages, include=FALSE}

# Load required packages

# to assess performance
library(profvis)
library(bench)
library(microbenchmark)

# to manipulate data
library(readxl)
library(dplyr)
library(tidyr)
library(purrr)
library(stringr)
library(tibble)

library(zoo)

# to visualize results
library(ggplot2)

## to export tables in excel format
library(openxlsx)

## to load own packages
library(credentials)
library(gitcreds)
library(devtools)

# Install own package from github as suggested here
# https://stackoverflow.com/a/71846333/6104907
if(!"bestcost" %in% installed.packages()[, "Package"]){
  #gitcreds::gitcreds_set()
  #usethis::use_git_config(user.name = "YourName", user.email = "your@mail.com") # run if installation doesn't work
  credentials::set_github_pat() # paste github PAT when prompted
  devtools::install_github(repo = "best-cost/best-cost_WPs",
                           subdir = "/r_package/bestcost",
                           # Branch (by default "HEAD")
                           # Other usual branches 
                           # "63-simplification-of-the-code"
                           # "Variable_names"
                           # "Small_code_changes"
                           ref = "HEAD",
                           force = TRUE)

}

# to quantify and monetize health impacts (own package)
library(bestcost)
# loads all functions in {bestcost}
#devtools::load_all() 
```


```{r Test probability of dying}
# Use function
prob_dying_airqplus <- 
  bestcost::get_prob_dying(
    first_age_pop = 0,
    last_age_pop = 14,
    interval_age_pop = 5,
    population_midyear = airqplus_deaths_pop_multipleYear$mi,
    deaths = airqplus_deaths_pop_multipleYear$di
  )
```


# Calculate health impacts

```{r impact morbidity}
impact_morbidities_raw <- list()

for(i in 1:nrow(input_data_morbidities)){
  impact_morbidities_raw[[input_data_morbidities$year[i]]][[input_data_morbidities$crf_id[[i]]]] <-
  bestcost::assess_impact_single(
    exp = input_data_morbidities$exp[i],  # PM2.5=8.30=limit LRV CH, NO2=16.32=mean conc. in CH in 2019
    cf = input_data_morbidities$cf[i],    # PM2.5=5, NO2=10, i.e. WHO AQG 2021 
    bhd = input_data_morbidities$bhd_absolute[i],
    crf = unlist(input_data_morbidities[i, 
                            c("crf_mean", "crf_lowci", "crf_highci")]) ,
    crf_per = 10, 
    crf_rescale_method = "loglinear", 
    info_pollutant = input_data_morbidities$pollutant[i], 
    info_outcome = input_data_morbidities$outcome_metric[i])
  }


impact_morbidities_edited <- 
  # Bind rows within the nested lists
  impact_morbidities_raw %>%
  purrr::map(., ~ dplyr::bind_rows(., .id = "crf_id")) 

impact_morbidities_comparative <- list()
for (r in c("2019", "whoaqg21")){ 
  # Substract the impacts for the scenarios
  impact_morbidities_comparative[[paste0(r, "_whoaqg21")]] <- 
    dplyr::left_join(impact_morbidities_edited[[r]],
                     impact_morbidities_edited[["whoaqg21"]][c("crf_id", "ci", "crf", "exp", "impact")], 
                     by = c("crf_id", "ci", "crf"), 
                     suffix = c("_ref", "_whoaqg21")) %>%
    dplyr::mutate(ref = r,
                  impact_diff = impact_ref - impact_whoaqg21)
}

impact_morbidities <- 
  impact_morbidities_comparative %>%
  dplyr::bind_rows(.) %>%

  # Remove columns 
  dplyr::select(-crf_forPaf) %>%

  
  # Pivot wider the ci
  tidyr::pivot_wider(
    values_from = c(crf, paf,
                    impact_ref, impact_whoaqg21, impact_diff), 
    names_from = ci) %>%
  # Paste the CIs
  dplyr::mutate(
    crf_meanCI = paste_round_CI(crf_mean, crf_lowci, crf_highci, 3),
    impact_ref_meanCI = paste_round_CI(impact_ref_mean, impact_ref_lowci, impact_ref_highci, 0),
    impact_whoaqg21_meanCI = paste_round_CI(impact_whoaqg21_mean, impact_whoaqg21_lowci, impact_whoaqg21_highci, 0),
    impact_diff_meanCI = paste_round_CI(impact_diff_mean, impact_diff_lowci, impact_diff_highci, 0)) %>%
  
      # Pivot wider the impacts
  tidyr::pivot_wider(
    values_from = 
      c(contains("_ref"),contains("_diff")),
    names_from = ref) %>%
  
    # Left join to add further information on crf
  dplyr::left_join(., crf_data, 
                   by = c( "crf_id", 
                          paste0("crf_", c("mean", "lowci", "highci"))),
                   relationship = "many-to-one") %>%
     # Left join to add further information on bhd
  dplyr::left_join(., unique(input_data_morbidities [, c("outcome_id", "bhd_absolute", "source_bhd", "choice_bhd")]), 
                   by = c("outcome_id", "bhd" = "bhd_absolute"),
                   relationship = "many-to-one") %>%
  # Left join to add label in German of outcomes
  dplyr::left_join(., codebook,
                   by = "outcome_id",
                   relationship = "many-to-one") %>%
  
  # Order columns 
  dplyr::select(pollutant, term, 
                bhd,
                crf_meanCI, 
                contains("impact_diff_meanCI"),
                contains("impact_ref_meanCI"), 
                impact_whoaqg21_meanCI,
                everything())

```



```{r impact mortality}
impact_mortality_raw <- list()

# Calculate mortality impacts using bestcost function

for(i in 1:nrow(input_data_mortality)){  # Use this if you want to evaluate multiple crfs
# for(i in 2){                           # Use this if you want to evaluate only one crfs
  impact_mortality_raw[[input_data_mortality$year[i]]][[input_data_mortality$crf_id[[i]]]] <-
  
    bestcost::assess_mortality_lifetable(

    exp = input_data_mortality$exp[i], # PM2.5=8.30=limit LRV CH, NO2=16.32=mean conc. in CH in 2019
    cf = input_data_mortality$cf[i],   # PM2.5=5, NO2=10, i.e. WHO AQG 2021 
    crf = unlist(input_data_mortality[i,
                                      c("crf_mean", "crf_lowci", "crf_highci")]),
    crf_per = 10, 
    crf_rescale_method = "loglinear",
    first_age_pop = 0,
    last_age_pop = 99,
    interval_age_pop = 1,
    prob_natural_death_male = lifetable_withPopulation[["male"]]$death_probability_natural,
    prob_natural_death_female = lifetable_withPopulation[["female"]]$death_probability_natural,
    prob_total_death_male = lifetable_withPopulation[["male"]]$death_probability_total,
    prob_total_death_female = lifetable_withPopulation[["female"]]$death_probability_total,
    population_male = lifetable_withPopulation[["male"]]$population, 
    population_female = lifetable_withPopulation[["female"]]$population, 
    year_of_analysis = 2019, 
    info_pollutant = input_data_mortality$pollutant[i], 
    min_age = input_data_mortality$min_age[i],
    max_age = input_data_mortality$max_age[i],
    corrected_discount_rate = 0)
}

impact_mortality_edited <- list()

impact_mortality_edited[["deaths"]] <- 
  # Extract only nested  lists with the name "deaths"  
  purrr::map_depth(impact_mortality_raw, 2, "deaths")
# Same with "yll"  
impact_mortality_edited[["yll"]] <- 
  purrr::map_depth(impact_mortality_raw, 2, "yll")

impact_mortality_edited <- impact_mortality_edited %>%
  # Unlist assigning id
  purrr::map(., map,  ~ dplyr::bind_rows(., .id = "crf_id")) %>%
  purrr::map(.,  ~ dplyr::bind_rows(., .id = "case")) %>%
  dplyr::bind_rows(., .id = "outcome_metric_short") %>%
  # Now list only scenario
  split(., .$case) 


# Put together the different scenarios
impact_mortality_comparative <- list()

for (r in c("2019", "whoaqg21")){ 
  # Substract the impacts for the scenarios
  impact_mortality_comparative[[paste0(r, "_whoaqg21")]] <- 
    dplyr::left_join(impact_mortality_edited[[r]],
                     impact_mortality_edited[["whoaqg21"]][c("crf_id", "ci", "impact", "impact_beforeRounding" ,"outcome_metric_short", "exp")], 
                     by = c("outcome_metric_short", "crf_id", "ci"), 
                     suffix = c("_ref", "_whoaqg21")) %>%
    dplyr::mutate(ref = r,
                  impact_diff = impact_ref - impact_whoaqg21,
                  impact_beforeRounding_diff = impact_beforeRounding_ref - impact_beforeRounding_whoaqg21)
  }

impact_mortality <- 
  impact_mortality_comparative %>%
  dplyr::bind_rows(.) %>%
  # Remove non relevant columns
  dplyr::select(-case, -crf_ci) %>%
  
  # Pivot wider CI
  tidyr::pivot_wider(
    values_from = c(crf, crf_forPaf, paf,
                    impact_ref, impact_whoaqg21, impact_diff,
                    impact_beforeRounding_ref, impact_beforeRounding_whoaqg21, impact_beforeRounding_diff), 
    names_from = ci) %>%
  # Paste the CIs
  dplyr::mutate(
    crf_meanCI = paste_round_CI(crf_mean, crf_lowci, crf_highci, 3),
    impact_ref_meanCI = paste_round_CI(impact_ref_mean, impact_ref_lowci, impact_ref_highci, 3),
    impact_whoaqg21_meanCI = paste_round_CI(impact_whoaqg21_mean, impact_whoaqg21_lowci, impact_whoaqg21_highci, 0),
    impact_diff_meanCI = paste_round_CI(impact_diff_mean, impact_diff_lowci, impact_diff_highci, 0),
    # bhd as NA just to match with structure of morbidities
    bhd = NA) %>%

    
  # Left join to add further information on crf
  dplyr::left_join(., crf_data, 
                   by = c("info_pollutant" = "pollutant", "crf_id", "crf_per",
                          paste0("crf_", c("mean", "lowci", "highci"))),
                   relationship = "many-to-one")%>%
  # Change outcome_id to ensure match with codebook
  dplyr::mutate(
    outcome_id = ifelse(outcome_metric_short %in% "yll",
                        gsub("premature deaths", "yll", outcome_id),
                        outcome_id)) %>%
  # Order columns 
  dplyr::select(info_pollutant, ref, outcome_id, crf_source, 
                term, bhd, crf_meanCI, 
                contains("impact_diff_meanCI"),
                contains("impact_ref_meanCI"), 
                impact_whoaqg21_meanCI,
                everything()) %>%
  # Order rows by label
  dplyr::arrange(desc(info_pollutant), ref, outcome_id, crf_source)

```

# Export 

```{r eval=FALSE, include=FALSE}
write.csv2(lifetable_airqplus,
            "../testing/output/lifetable_airqplus_2019_ch.csv", 
            row.names = FALSE)
```
